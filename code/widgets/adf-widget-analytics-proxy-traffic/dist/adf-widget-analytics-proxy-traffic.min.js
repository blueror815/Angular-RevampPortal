!function(t,i){"use strict";function e(t,i,e,o){"ngInject";function a(t){var i={from_timestamp:moment().subtract(1,"hours").valueOf(),to_timestamp:Date.now()};return _.forEach(t,function(t,e){-1!==_.indexOf(n,e)?"-"!==t&&""!==t&&(i[e]=t):"count_last_hours"===e&&(i.from_timestamp=moment().subtract(t,"hours").valueOf(),i.to_timestamp=Date.now(),delete i.count_last_hours)}),i}var n=["domainId","from_timestamp","to_timestamp","country"],s={filters:{count_last_hours:"1",country:"-"},info:{country:"All countries"}};_.defaultsDeep(t.config,s),t.domain=t.config.domain,e.query().$promise.then(function(i){t.countries=i,t.reload()}),t.reload=function(){if(t.config.domain){var i={domainId:t.config.domain.id,country:t.config.filters.country,count_last_hours:t.config.filters.count_last_hours||"1"};t.reloadRequestStatus(i)}},t.reloadRequestStatus=function(i){t.requestStatus=[],o.requestStatus(a(i)).$promise.then(function(i){if(i.data&&i.data.length>0){var e=[{name:"Successfull",y:0},{name:"Failed",y:0}];angular.forEach(i.data,function(t){"OK"===t.key?e[0].y=t.count:e[1].y+=t.count}),t.requestStatus=e}})}}e.$inject=["$scope","config","Countries","Stats"],angular.module("adf.widget.analytics-proxy-traffic",["adf.provider"]).config(["dashboardProvider",function(t){function i(t,i,e,o){"ngInject";var a={filters:{count_last_hours:"6",map_type:"world"}};_.defaultsDeep(t.config,a),t.domain=t.config.domain,t.onDomainSelected=function(){t.domain&&t.domain.id&&t.reload()},t.reload=function(){angular.extend(t.config,{domain:angular.copy(t.domain)})}}function e(t,i,e,o,a,n,s,l){"ngInject";var r={filters:{count_last_hours:"6",map_type:"world"}};_.defaultsDeep(t.config,r),t.elId=(new Date).getTime(),t._loading=!1,t._data=!1,n.query().$promise.then(function(i){t.reload(),t.countries=i}),t.reload=function(){if(t.config.domain){t._data=!1;var i=!1,e={domainId:t.config.domain.id,count_last_hours:t.config.filters.count_last_hours||"6",from_timestamp:moment().subtract(t.config.filters.count_last_hours,"hours").valueOf(),to_timestamp:Date.now()};t.reloadGBTCountry(e).then(function(e){t._data=!0,i=s.create("#canvas-svg-gbt"+t.elId),"world"===t.config.filters.map_type?i.drawWorldMap(e,{legend:{symbolWidth:360}}):i.drawUSAMap(e,{legend:{symbolWidth:360}})})["finally"](function(){t._loading=!1})}},t.reloadGBTCountry=function(i){return t._loading=!0,a.gbt_country({domainId:i.domainId,count:250,from_timestamp:moment().subtract(i.count_last_hours||"6","hours").valueOf(),to_timestamp:Date.now()}).$promise.then(function(i){var e=[],o=[];return i.data&&i.data.length>0&&(i.data.forEach(function(i){var a=i.key.toUpperCase();e.push({name:t.countries[a]||i.key,id:a,value:i.sent_bytes,tooltip:"Sent: <strong>"+l.humanFileSizeInGB(i.sent_bytes)+"</strong> Received: <strong>"+l.humanFileSizeInGB(i.received_bytes)+"</strong>"}),"US"===a&&i.regions&&(o=i.regions)}),o=o.map(function(t){return{id:t.key,name:t.key,value:t.sent_bytes,tooltip:"Sent: <strong>"+l.humanFileSizeInGB(t.sent_bytes)+"</strong> Received: <strong>"+l.humanFileSizeInGB(t.received_bytes)+"</strong>"}})),{world:e,usa:o}})}}function o(t,i,e,o,a){"ngInject";var n={filters:{count_last_hours:"1",country:"-"},info:{country:"All countries"}};_.defaultsDeep(t.config,n),t.domain=t.config.domain,o.query().$promise.then(function(i){t.refCountries=i}),t.onDomainSelected=function(){t.domain&&t.domain.id&&t.reload()},t.reload=function(){angular.extend(t.config,{domain:angular.copy(t.domain)})},t.$watch("config.filters",function(i,e){"-"===i.country?angular.extend(t.config.info,{country:i.country}):angular.extend(t.config.info,{country:t.refCountries[i.country.toUpperCase()]||i.country.toUpperCase()})},!0)}function a(t,i,e){"ngInject";function o(t){var i={from_timestamp:moment().subtract(1,"hours").valueOf(),to_timestamp:Date.now()};return _.forEach(t,function(t,e){-1!==_.indexOf(a,e)?"-"!==t&&""!==t&&(i[e]=t):"count_last_hours"===e&&(i.from_timestamp=moment().subtract(t,"hours").valueOf(),i.to_timestamp=Date.now(),delete i.count_last_hours)}),i}var a=["domainId","from_timestamp","to_timestamp","country"],n={filters:{count_last_hours:"1",country:"-"},info:{country:"All countries"}};_.defaultsDeep(t.config,n),i.query().$promise.then(function(i){t.countries=i,t.reload()}),t.reload=function(){if(t.config.domain){var i={domainId:t.config.domain.id,country:t.config.filters.country,count_last_hours:t.config.filters.count_last_hours||"6"};t.reloadTopReportCountry(i)}},t.country=[],t.reloadTopReportCountry=function(i){e.country(o(i)).$promise.then(function(i){t.country.lenght=0,i.data&&i.data.length>0&&i.data.forEach(function(i){var e=t.countries[i.key.toUpperCase()]||"Unknown";t.country.push({name:e,y:i.count})})})}}e.$inject=["$scope","$q","$window","$timeout","Stats","Countries","HeatmapsDrawer","Util"],i.$inject=["$scope","$window","$timeout","Stats"],a.$inject=["$scope","Countries","Stats"],o.$inject=["$scope","$window","$timeout","Countries","Stats"];var n={title:"Proxy Traffic",description:"Web Alalytics Proxy Traffic",titleTemplateUrl:"parts/dashboard/widgets/proxy-traffic/widget-title-with-params-proxy-traffic.html",templateUrl:"{widgetsPath}/analytics-proxy-traffic/src/view.html",editTemplateUrl:"parts/dashboard/widgets/widget-edit.html",styleClass:"rev-widget",controller:["$scope","$window",function(t,i,e){i.dispatchEvent(new Event("resize"));var o={filters:{country:"-",os:"-",device:"-",count_last_day:"1"}};_.defaultsDeep(t.config,o)}],edit:{templateUrl:"parts/dashboard/widgets/proxy-traffic/edit-proxy-traffic.html",controller:["$scope","$q","Stats","Countries","User","AlertService",function(t,i,e,o,a,n){var s={filters:{country:"-",os:"-",device:"-",count_last_day:"1"},info:{country:"All countries"}};_.defaultsDeep(t.config,s),t.domain=t.config.domain,t.$watch("config.filters",function(i,e){i&&i.country&&("-"===i.country?angular.extend(t.config.info,{country:i.country}):angular.extend(t.config.info,{country:t.flCountry[i.country.toUpperCase()]||i.country.toUpperCase()}))},!0),t.onDomainSelected=function(){t.domain&&t.domain.id&&t.reload()},t.reload=function(){angular.extend(t.config,{domain:angular.copy(t.domain)}),t.reloadCountry(t.domain.id),t.reloadOS(t.domain.id),t.reloadDevice(t.domain.id),t.reloadStatusCode(t.domain.id)},t.flCountry={},t.reloadCountry=function(i){t.flCountry=o.query()},t.flOs={labels:[],data:[]},t.reloadOS=function(i){e.os({domainId:i}).$promise.then(function(i){t.flOs.labels.length=0,t.flOs.data.length=0,i.data&&i.data.length>0&&angular.forEach(i.data,function(i){t.flOs.labels.push(i.key),t.flOs.data.push(i.count)})})},t.flDevice={labels:[],data:[]},t.reloadDevice=function(i){e.device({domainId:i}).$promise.then(function(i){t.flDevice.labels.length=0,t.flDevice.data.length=0,i.data&&i.data.length>0&&angular.forEach(i.data,function(i){t.flDevice.labels.push(i.key),t.flDevice.data.push(i.count)})})},t.statusCode={labels:[],data:[]},t.reloadStatusCode=function(i){return e.statusCode({domainId:i}).$promise.then(function(i){t.statusCode.labels.length=0,t.statusCode.data.length=0,i.data&&i.data.length>0&&(angular.forEach(i.data,function(i){t.statusCode.labels.push(i.key),t.statusCode.data.push(i.count)}),t.config.statusCode=t.statusCode.labels)})},a.getUserDomains(!0)}]}};t.widget("analytics-proxy-traffic-bandwidth-usage",angular.extend(n,{title:"Bandwidth Usage",description:"Display Bandwidth Usage Graph",templateUrl:"{widgetsPath}/analytics-proxy-traffic/src/views/view-requests-chart.tpl.html"})).widget("analytics-proxy-traffic-chart",angular.extend(n,{title:"Total Requests",description:"Display Total Requests Graph",templateUrl:"{widgetsPath}/analytics-proxy-traffic/src/views/view-proxy-traffic-chart.tpl.html"})).widget("analytics-proxy-traffic-http-https-chart",angular.extend(n,{title:"HTTP/HTTPS Hits",description:"Display HTTP/HTTPS Hits Graph",templateUrl:"{widgetsPath}/analytics-proxy-traffic/src/views/view-http-https-chart.tpl.html"})).widget("analytics-proxy-hits-cache-chart",angular.extend(n,{title:"Edge Cache Efficiency Hits",description:"Display Edge Cache Hit/Miss Graph",templateUrl:"{widgetsPath}/analytics-proxy-traffic/src/views/view-hits-cache-chart.tpl.html"})).widget("adf-widget-gbt-heatmaps",{title:"World Traffic Heatmap",titleTemplateUrl:"parts/dashboard/widgets/heatmaps/widget-title-with-params-heatmap.html",description:"Display Global Traffic Heatmap",templateUrl:"parts/dashboard/widgets/heatmaps/view-gbt-heatmaps.tpl.html",controller:e,edit:{templateUrl:"parts/dashboard/widgets/heatmaps/edit-heatmap.html",controller:i}}).widget("adf-widget-top-10-countries",{title:"Top 10 Countries",titleTemplateUrl:"parts/dashboard/widgets/top-reports/widget-title-with-params-top-reports.html",description:"Display Top 10 Countries Pie Chart",templateUrl:"parts/dashboard/widgets/top-reports/view-top-10-countries.tpl.html",controller:a,edit:{templateUrl:"parts/dashboard/widgets/top-reports/edit-top-reports.html",controller:o}}).widget("adf-widget-http-https-requests-ratio",{title:"Request Success/Failure Ratio",description:"Display Success/Failure Ratio Pie Chart",titleTemplateUrl:"parts/dashboard/widgets/top-reports/widget-title-with-params-top-reports.html",templateUrl:"parts/dashboard/widgets/top-reports/view-request-success-fialure-ratio.tpl.html",controller:"widgetRequestSuccessFailureRatioCtrl",edit:{templateUrl:"parts/dashboard/widgets/top-reports/edit-top-reports.html",controller:o}})}]),angular.module("adf.widget.analytics-proxy-traffic").run(["$templateCache",function(t){t.put("{widgetsPath}/analytics-proxy-traffic/src/edit.html",'<form role=form><div class=form-group><label for=domain>Domain</label><div domain-select id=domain ng-model=domain on-select=onDomainSelected() select-one=true></div></div><div class=form-group><label for=domain>Filters</label>{{config.filters}}</div><div class=form-inline><div class=form-group><select id=country class="form-control fixed" ng-model=config.filters.country ng-disabled=!domain><option value=->All Countries</option><option ng-repeat="(key, item) in flCountry" value={{key}}>{{item}}</option></select></div><div class=form-group><select id=os class="form-control fixed" ng-model=config.filters.os ng-disabled=!domain><option value=->All OS</option><option ng-repeat="item in flOs.labels" value={{item}}>{{item}}</option></select></div><div class=form-group><select id=device class="form-control fixed" ng-model=config.filters.device ng-disabled=!domain><option value=->All Devices</option><option ng-repeat="item in flDevice.labels" value={{item}}>{{item}}</option></select></div></div><div class=form-group><label for=domain>Time Period</label></div><div class=form-group></div></form>'),t.put("{widgetsPath}/analytics-proxy-traffic/src/view.html","<div><h1>Widget view</h1><p>Content of {{config.sample}}</p></div>"),t.put("{widgetsPath}/analytics-proxy-traffic/src/widget-edit.html",'<form name=widgetEditForm novalidate role=form ng-submit=saveDialog()><div class=modal-header><button type=button class=close ng-click=closeDialog() aria-hidden=true>&times;</button><h4 class=modal-title>{{widget.title}}</h4></div><div class=modal-body><div class="alert alert-danger" role=alert ng-show=validationError><strong>Apply error:</strong> {{validationError}}</div><div ng-if=widget.edit><adf-widget-content model=definition content=widget.edit></adf-widget-content></div></div><div class=modal-footer><button type=button class="btn btn-default" ng-click=closeDialog()>Cancel</button> <input type=submit class="btn btn-primary" ng-disabled=widgetEditForm.$invalid value=Apply></div></form>'),t.put("{widgetsPath}/analytics-proxy-traffic/src/widget-title-with-params.html",'<h3 class=panel-title>{{definition.title}} <span ng-if=!!definition.config.domain>(<strong>{{definition.config.domain.domain_name}}</strong>)</span> <span class=pull-right><a title="reload widget content" ng-if=widget.reload ng-click=reload()><i class="glyphicon glyphicon-refresh"></i></a> <a title="Change Widget Location" class=adf-move ng-if=editMode><i class="glyphicon glyphicon-move"></i></a> <a title="Collapse Widget" ng-show="options.collapsible && !widgetState.isCollapsed" ng-click="widgetState.isCollapsed = !widgetState.isCollapsed"><i class="glyphicon glyphicon-minus"></i></a> <a title="Expand Widget" ng-show="options.collapsible && widgetState.isCollapsed" ng-click="widgetState.isCollapsed = !widgetState.isCollapsed"><i class="glyphicon glyphicon-plus"></i></a> <a title="Edit Widget Configuration" ng-click=edit() ng-if=editMode><i class="glyphicon glyphicon-cog"></i></a> <a title="Fullscreen Widget" ng-click=openFullScreen() ng-show=options.maximizable><i class="glyphicon glyphicon-fullscreen"></i></a> <a title="Remove Widget" ng-click=remove() ng-if=editMode><i class="glyphicon glyphicon-remove"></i></a></span></h3><small ng-if=definition.config.filters.count_last_day>Last {{definition.config.filters.count_last_day}} Day</small> <span class=widget_filters_info ng-show=!!definition.config.filters[index.key] ng-repeat="index in [{key:\'os\',title:\'OS\'},{key:\'country\',title:\'Сountry\'},{key:\'device\',title:\'Device\'}]"><small ng-if="!!definition.config.filters[index.key]&& definition.config.filters[index.key]!==\'-\'">&nbsp;{{index.title}}: {{definition.config.filters[index.key]}}&nbsp;</small></span> <span></span>'),t.put("{widgetsPath}/analytics-proxy-traffic/src/views/view-hits-cache-chart.tpl.html",'<div class=col-lg-12><div class="alert alert-info" ng-if=!config.domain>Please click on <i class="glyphicon glyphicon-cog"></i> icon to configure the widget</div><div ng-if=config.domain hits-cache-chart filters-sets=config.filters ng-domain=config.domain></div></div>'),t.put("{widgetsPath}/analytics-proxy-traffic/src/views/view-http-https-chart.tpl.html",'<div class=col-lg-12><div class="alert alert-info" ng-if=!config.domain>Please click on <i class="glyphicon glyphicon-cog"></i> icon to configure the widget</div><div ng-if=config.domain http-https-chart filters-sets=config.filters ng-domain=config.domain></div></div>'),t.put("{widgetsPath}/analytics-proxy-traffic/src/views/view-http-status-code-chart.tpl.html",'<div class=col-lg-12><div class="alert alert-info" ng-if=!config.domain>Please click on <i class="glyphicon glyphicon-cog"></i> icon to configure the widget</div><div ng-if=config.domain http-status-code-chart filters-sets=config.filters status-codes=config.statusCode ng-domain=config.domain></div></div>'),t.put("{widgetsPath}/analytics-proxy-traffic/src/views/view-proxy-traffic-chart.tpl.html",'<div class=col-lg-12><div class="alert alert-info" ng-if=!config.domain>Please click on <i class="glyphicon glyphicon-cog"></i> icon to configure the widget</div><div ng-if=config.domain proxy-traffic-chart filters-sets=config.filters status-codes=config.statusCode.labels ng-domain=config.domain></div></div>'),t.put("{widgetsPath}/analytics-proxy-traffic/src/views/view-request-status-chart.tpl.html",'<div class=col-lg-12><div class="alert alert-info" ng-if=!config.domain>Please click on <i class="glyphicon glyphicon-cog"></i> icon to configure the widget</div><div ng-if=config.domain request-status-chart status-codes=config.statusCode fl-os=config.os.labels fl-device=config.device.labels fl-country=config.countries ng-domain=config.domain></div></div>'),t.put("{widgetsPath}/analytics-proxy-traffic/src/views/view-requests-chart.tpl.html",'<div class=col-lg-12><div class="alert alert-info" ng-if=!config.domain>Please click on <i class="glyphicon glyphicon-cog"></i> icon to configure the widget</div><div ng-if=config.domain requests-chart filters-sets=config.filters ng-domain=config.domain></div></div>'),t.put("{widgetsPath}/analytics-proxy-traffic/src/views/parts/panel-filter-settings.tpl.html","<div ng-show=!!config.filters[index.key] class=col-md-3 ng-repeat=\"index in [{key:'os',title:'OS'},{key:'country',title:'Сountry'},{key:'device',title:'Device'}]\"><small>{{index.title}}: {{config.filters[index.key]}}</small></div>"),t.put("{widgetsPath}/analytics-proxy-traffic/src/views/parts/title-with-filter-params.tpl.html","")}]),angular.module("adf.widget.analytics-proxy-traffic").controller("widgetRequestSuccessFailureRatioCtrl",e)}(window);